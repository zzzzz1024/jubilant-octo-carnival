---
description: 当需要编写脚本时, 你应该参考本文件
<<<<<<< HEAD
=======
alwaysApply: false
>>>>>>> 144270117e5c2d7250e461da58e402f15c661485
---
# 脚本

如果 `src/xxx` 文件夹中仅有 `index.ts` 文件, 则它是一个脚本项目.

脚本以无沙盒 iframe 的形式在酒馆后台运行, 没有自己的界面, 只有代码部分可供编写.

## jquery

<<<<<<< HEAD
脚本中的 jquery 将直接作用于整个酒馆页面而非仅作用于脚本所在的 iframe. 例如 `$('body')` 将选择酒馆网页的 `<body>` 标签, 而不是脚本所在的 iframe 的 `<body>` 标签.
=======
脚本中的 jquery 将直接作用于整个酒馆页面而非仅作用于脚本所在的 iframe, 因为它是通过 `window.$ = window.parent.$` 得到的. 例如 `$('body')` 将选择酒馆网页的 `<body>` 标签, 而不是脚本所在的 iframe 的 `<body>` 标签.
>>>>>>> 144270117e5c2d7250e461da58e402f15c661485

## vue

由于脚本运行在 iframe 中, 当需要在脚本中向酒馆页面挂载 vue 组件时, 你应该使用 jquery 来创建一个要挂载的位置, 将其添加到酒馆网页上, 并使用 `app.mount($app[0])` 来挂载.

<<<<<<< HEAD
此外, vue-style-loader 会将样式注入到 iframe 的 `<head>` 中, 为了使样式生效, 你需要:

- 在 vue 组件中使用 scoped style 从而让组件具有 `data-v-xxx` 属性
- 在 mount 后获取该属性, 使用 `$('head > style:contains("data-v-xxx")', document)` 查找样式来尾附到组件所在的元素中.

即,

```typescript
const $app = $('<div>').attr('id', 'input_helper');
const app = createApp(panel);

export function init_panel() {
  $('#extensions_settings2').append($app);

  app.mount($app[0]);

  const scope_id = $app
    .find('div')[0]
    .getAttributeNames()
    .find(value => value.startsWith('data-v-'));
  $app.append($(`head > style:contains("${scope_id}")`, document));
}

export function destroy_panel() {
  app.unmount();
  $app.remove();
}
```

=======
## 向酒馆网页挂载 vue 组件时的样式问题

由于脚本运行在 iframe 中, 脚本所设置的 style (包括 tailwindcss 产生的) 仅会在 iframe 内生效而不会应用到整个酒馆网页; 也就是说, 当我们用 jquery 创建了挂载位置, 并想将 vue 组件挂载到酒馆网页上时, 组件所需要的样式、所填写的 tailwindcss class 都无法生效.

基于 vue 组件用途, 这有两个解决方案.

### 组件是对酒馆网页的补充，需要使用酒馆网页的样式

组件可能是用来增强酒馆网页的界面使用体验，或需要与酒馆网页目前的样式保持一致的, 则应该挂载在非 iframe DOM 上. 例如:

```ts
$(() => {
  const app = createApp(App).use(createPinia());

  const $app = createScriptIdDiv().appendTo('想要放置的位置');
  app.mount($app[0]);

  // 关闭脚本时卸载组件
  $(window).on('pagehide', () => {
    app.unmount();
    $app.remove();
  });
});
```

这种组件应该尽量参考酒馆网页原有样式; 为了让脚本里为组件设置的额外样式生效, 我们需要使用 `util/script.ts` 中的 `teleportStyle` 函数来将样式复制到酒馆网页的 `<head>` 中.

```ts
const { destroy } = teleportStyle();
```

在关闭脚本时, 我们需要调用 `destroy` 函数来卸载样式.

```ts
$(window).on('pagehide', () => {
  destroy();
});
```

**但为了不与酒馆网页中已经有的类名冲突, 针对这种情况, 我们禁止使用 tailwindcss.**

### 组件是独立的，不需要使用酒馆网页的样式

组件可能是单独的悬浮窗、手机样式的对话界面或对酒馆网页的大幅调整, 需要与酒馆网页现有样式隔离, 则应该挂载在 iframe DOM 上. 为此我们使用 `util/script.ts` 中的 `createScriptIdIframe` 函数来创建 iframe DOM, 并将 vue 组件在 iframe load 完成后挂载到 iframe 内部的 body 上 (`iframe_element.contentDocument!.body`):

```ts
$(() => {
  const app = createApp(App).use(createPinia());

  const $app = createScriptIdIframe()
    .appendTo('想要放置的位置')
    .on('load', () => {
      teleportStyle($app[0].contentDocument!.head);
      app.mount($app[0].contentDocument!.body);
    });

  // 关闭脚本时卸载组件
  $(window).on('pagehide', () => {
    app.unmount();
    $app.remove();
  });
});
```

这种情况应该**优先使用无须自行复制样式的 tailwindcss class**; 否则, 如果有需要复制的样式, 则需要使用 `teleportStyle($app[0].contentDocument!.head)` 函数来复制样式.

>>>>>>> 144270117e5c2d7250e461da58e402f15c661485
## 脚本设置

如果需要为用户提供自定义设置, 可以使用脚本变量, 并用 `zod` 来定义设置的类型和默认值.

## 按钮

脚本可以在酒馆助手脚本库界面中设置按钮, 用户点击按钮时将会触发对应的事件.

我们可以在代码中这样注册按钮事件:

```typescript
eventOn(getButtonEvent('按钮名'), () => {
  console.log('按钮被点击了');
});
```
